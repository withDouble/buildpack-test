#!/usr/bin/env bash

ENV_DIR=${3:-}
build_dir=${1:-}

# Install 1Password CLI if not present
# Install to build_dir/.heroku/bin since we don't have write access to /usr/local/bin on Heroku
OP_BIN_DIR="${build_dir}/.heroku/bin"
mkdir -p "${OP_BIN_DIR}"

# Add op directory to PATH first so we can use it
export PATH="${OP_BIN_DIR}:${PATH}"

# Log relevant config vars for debugging (mask sensitive values)
echo "-----> Checking environment variables"
echo "       OP_SERVICE_ACCOUNT_TOKEN: ${OP_SERVICE_ACCOUNT_TOKEN:+SET (${#OP_SERVICE_ACCOUNT_TOKEN} chars)}${OP_SERVICE_ACCOUNT_TOKEN:-NOT SET}"
echo "       SOURCE_VERSION: ${SOURCE_VERSION:-NOT SET}"
if [ -n "${OP_SERVICE_ACCOUNT_TOKEN:-}" ]; then
	# Show first 4 and last 4 chars for verification, but mask the middle
	masked_token="${OP_SERVICE_ACCOUNT_TOKEN:0:4}...${OP_SERVICE_ACCOUNT_TOKEN: -4}"
	echo "       OP_SERVICE_ACCOUNT_TOKEN preview: ${masked_token}"
fi

# List other relevant env vars (filter for OP_, NPM_, NODE_ prefixes)
echo "       Relevant env vars:"
env | grep -E '^(OP_|NPM_|NODE_|SOURCE_VERSION)=' | sed 's/^/         /' || echo "         (none found)"

if ! command -v op &> /dev/null && [ ! -f "${OP_BIN_DIR}/op" ]; then
	echo "-----> Installing 1Password CLI"
	OP_VERSION="v2.26.0"
	ARCH="amd64"
	OS="linux"
	
	OP_URL="https://cache.agilebits.com/dist/1P/op2/pkg/${OP_VERSION}/op_${OS}_${ARCH}_${OP_VERSION}.zip"
	
	curl -sSfL "${OP_URL}" -o /tmp/op.zip
	unzip -q /tmp/op.zip -d /tmp
	chmod +x /tmp/op
	mv /tmp/op "${OP_BIN_DIR}/op"
	rm -f /tmp/op.zip
fi

# Get token from 1Password
export OP_SERVICE_ACCOUNT_TOKEN="${OP_SERVICE_ACCOUNT_TOKEN:-}"

if [ -z "${OP_SERVICE_ACCOUNT_TOKEN}" ]; then
	echo "-----> WARNING: OP_SERVICE_ACCOUNT_TOKEN not set"
	echo "       Skipping .npmrc creation from 1Password"
	echo "       Set OP_SERVICE_ACCOUNT_TOKEN config var in Heroku to enable private npm package access"
else
	echo "-----> Fetching NPM token from 1Password"
	
	# Capture both stdout and stderr, and check exit code
	if npm_read_token=$(op read "op://CI-CD/NPM Read Token/password" 2>&1); then
		if [ -n "$npm_read_token" ]; then
			echo "-----> Using .npmrc from 1Password"
			echo "//registry.npmjs.org/:_authToken=${npm_read_token}" > "$build_dir/.npmrc"
		else
			echo "-----> ERROR: Token retrieved but is empty"
			echo "       Build will continue but may fail if private packages are required"
		fi
	else
		error_output="$npm_read_token"
		echo "-----> ERROR: Failed to read token from 1Password"
		echo "       Error: ${error_output}"
		echo "       Verify OP_SERVICE_ACCOUNT_TOKEN is set correctly in Heroku config vars"
		echo "       Build will continue but may fail if private packages are required"
	fi
fi

# Ensure profile.d directory exists for Datadog env
mkdir -p "$build_dir/.profile.d"
echo "export DD_GIT_COMMIT_SHA=$SOURCE_VERSION" >> $build_dir/.profile.d/datadog.sh

exit 0
