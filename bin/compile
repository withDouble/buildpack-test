#!/usr/bin/env bash

# Abort immediately if anything goes wrong, don’t guess, don’t continue.
set -euo pipefail

# Heroku buildpack args: compile BUILD_DIR CACHE_DIR ENV_DIR
BUILD_DIR="${1:?missing BUILD_DIR (arg 1)}"
CACHE_DIR="${2:?missing CACHE_DIR (arg 2)}"
ENV_DIR="${3:?missing ENV_DIR (arg 3)}"

# 1Password reference path
VAULT_NAME="CI-CD"
ITEM_NAME="NPM Read Token"
FIELD_NAME="password"
OP_NPM_TOKEN_PATH="op://${VAULT_NAME}/${ITEM_NAME}/${FIELD_NAME}"

# Directories - use cache directory to avoid re-downloading the 1Password CLI on every build
OP_BIN_DIR="${CACHE_DIR}/opcli/bin"
mkdir -p "$OP_BIN_DIR"

# Add to PATH for this build step
export PATH="${OP_BIN_DIR}:${PATH}"

# Install 1Password CLI (cached)
if [ ! -x "${OP_BIN_DIR}/op" ]; then
  echo "-----> Installing 1Password CLI (cached)"
  curl -fsSL "https://cache.agilebits.com/dist/1P/op2/pkg/v2.26.0/op_linux_amd64_v2.26.0.zip" -o /tmp/op.zip
  unzip -q /tmp/op.zip -d /tmp
  install -m 0755 /tmp/op "${OP_BIN_DIR}/op"
  rm -f /tmp/op.zip
fi

# Add OP directory to PATH
export PATH="${OP_BIN_DIR}:${PATH}"

# Load 1Password SA token from ENV_DIR
if [ ! -f "${ENV_DIR}/OP_SERVICE_ACCOUNT_TOKEN" ] || [ ! -s "${ENV_DIR}/OP_SERVICE_ACCOUNT_TOKEN" ]; then
  echo "-----> ERROR: OP_SERVICE_ACCOUNT_TOKEN not found or empty in ENV_DIR"
  exit 1
fi
export OP_SERVICE_ACCOUNT_TOKEN="$(cat "${ENV_DIR}/OP_SERVICE_ACCOUNT_TOKEN")"

echo "-----> Fetching NPM token from 1Password"
NPM_TOKEN_VALUE="$(
  op read "${OP_NPM_TOKEN_PATH}" 2>/dev/null || true
)"

if [ -z "${NPM_TOKEN_VALUE}" ]; then
  echo "-----> ERROR: NPM token missing or unreadable from 1Password"
  exit 1
fi

# # Make token available to the Node.js buildpack (no file written)
# export NPM_TOKEN="${NPM_TOKEN_VALUE}"

# # Constrain npm to always-auth so scoped packages work consistently
# export NPM_CONFIG_ALWAYS_AUTH=true

# # Ensure .npmrc exists and contains required lines
# NPMRC_PATH="${BUILD_DIR}/.npmrc"
# REQUIRED_AUTH_LINE='always-auth=true'
# REQUIRED_TOKEN_LINE='//registry.npmjs.org/:_authToken=${NPM_TOKEN}'

# echo "-----> Ensuring .npmrc configuration"

# # If .npmrc doesn't exist, create it
# if [ ! -f "${NPMRC_PATH}" ]; then
#   echo "-----> Creating new .npmrc"
#   cat > "${NPMRC_PATH}" <<EOF
# ${REQUIRED_AUTH_LINE}
# ${REQUIRED_TOKEN_LINE}
# EOF
# else
#   # Ensure it has the always-auth line
#   if ! grep -qF "${REQUIRED_AUTH_LINE}" "${NPMRC_PATH}"; then
#     echo "${REQUIRED_AUTH_LINE}" >> "${NPMRC_PATH}"
#   fi

#   # Ensure it has the token reference line
#   if ! grep -qF "${REQUIRED_TOKEN_LINE}" "${NPMRC_PATH}"; then
#     echo "${REQUIRED_TOKEN_LINE}" >> "${NPMRC_PATH}"
#   fi
# fi

# # Sanity check: confirm file was created and contains both lines
# if [ ! -s "${NPMRC_PATH}" ] || ! grep -qF "${REQUIRED_TOKEN_LINE}" "${NPMRC_PATH}"; then
#   echo "-----> ERROR: Failed to create or verify .npmrc"
#   exit 1
# fi

# WRITE TOKEN TO USER-LEVEL NPMRC (visible to subsequent buildpacks, not slugged)
USER_NPMRC="${HOME}/.npmrc"
cat > "${USER_NPMRC}" <<EOF
always-auth=true
@withdouble:registry=https://registry.npmjs.org/
//registry.npmjs.org/:_authToken=${NPM_TOKEN_VALUE}
EOF
chmod 0600 "${USER_NPMRC}"

# Sanitize repo npmrc so it can't clobber user-level auth
PROJ_NPMRC="${BUILD_DIR}/.npmrc"
if [ -f "${PROJ_NPMRC}" ]; then
  sed -i -E '/:_authToken=/d' "${PROJ_NPMRC}" || true
  sed -i -E '/NPM_TOKEN/d'   "${PROJ_NPMRC}" || true
  grep -qE '^always-auth=' "${PROJ_NPMRC}" || echo "always-auth=true" >> "${PROJ_NPMRC}"
  grep -qE '^@withdouble:registry=' "${PROJ_NPMRC}" || echo "@withdouble:registry=https://registry.npmjs.org/" >> "${PROJ_NPMRC}"
fi

echo "-----> [debug] env summary"
echo "HOME=$HOME"
echo "PWD=$PWD"
command -v node >/dev/null 2>&1 && node -v || echo "node: (not yet)"
command -v npm  >/dev/null 2>&1 && npm  -v || echo "npm:  (not yet)"

echo "-----> [debug] check ~/.npmrc exists"
if [ -f "$HOME/.npmrc" ]; then
  ls -l "$HOME/.npmrc"
  echo "[first 3 lines]"
  head -n 3 "$HOME/.npmrc" || true
else
  echo "(no ~/.npmrc found)"
fi

PROJ_NPMRC="${BUILD_DIR}/.npmrc"
echo "-----> [debug] check project .npmrc at $PROJ_NPMRC"
if [ -f "$PROJ_NPMRC" ]; then
  ls -l "$PROJ_NPMRC"
  echo "[first 5 lines]"
  head -n 5 "$PROJ_NPMRC" || true
else
  echo "(no project .npmrc)"
fi

echo "-----> [debug] npm config paths (if npm present)"
npm config get userconfig 2>/dev/null || true
npm config get globalconfig 2>/dev/null || true
npm config get @withdouble:registry 2>/dev/null || true

echo "-----> [debug] npm view smoke test (if npm present)"
npm view @withdouble/ordering@0.1.1 name version 2>/dev/null \
  && echo "[OK] npm view succeeded here" \
  || echo "[WARN] npm view not available yet (Node buildpack hasn’t installed npm)"




# Ensure profile.d directory exists for Datadog env
mkdir -p "$BUILD_DIR/.profile.d"
echo "export DD_GIT_COMMIT_SHA=$SOURCE_VERSION" >> $BUILD_DIR/.profile.d/datadog.sh

exit 0
